<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Professor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/3da44e21a2.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css"> 
    <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-icon">
                    </div>
            </div>
            <ul class="sidebar-list">
                <li class="sidebar-list-item active" data-target="turmas">
                    <a href="#">
                        <i class="fas fa-home me-2"></i>
                        <span>Turmas</span>
                    </a>
                </li>
            </ul>
            <div class="account-info">
                <div class="account-info-picture">
                    <img src="https://static.vecteezy.com/system/resources/previews/014/300/061/non_2x/man-profile-glyph-icon-anonymous-photo-for-documents-illustration-vector.jpg" alt="Account">
                </div>
                <span id="nome-professor">Carregando...</span>
                <button class="account-info-more" id="account-info-more">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                </button>
                <div class="account-info-menu" id="account-info-menu">
                    <button id="logout-button" class="btn btn-danger btn-sm">Sair</button>
                </div>
            </div>
        </div>
        <div class="app-content">
            <div class="app-content-header">
                <h1 class="app-content-headerText" id="page-title">Turmas</h1>
            </div>
            <div class="app-content-actions">
            </div>
            <div class="products-area-wrapper tableView" id="conteudo-principal">
                <div class="products-header">
                    <div class="product-cell category">Turma<button class="sort-button">
                        </div>
                </div> 
                <!-- Turmas do professor serão listadas aqui -->
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script type="module">
    // Firebase configuration
    const firebaseConfig = {
            apiKey: "AIzaSyAbzHqrxU1bfZlCe8LWtizy12-40zdUfDE",
            authDomain: "teste-97fc6.firebaseapp.com",
            projectId: "teste-97fc6",
            storageBucket: "teste-97fc6.appspot.com",
            messagingSenderId: "470428227917",
            appId: "1:470428227917:web:ef9308034050ca366a3f04",
            measurementId: "G-F50QJE3734"
        };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

        const nomeProfessorSpan = document.getElementById('nome-professor');
        const conteudoPrincipal = document.getElementById('conteudo-principal');

        auth.onAuthStateChanged(user => {
            if (user) {
                carregarProfessor(user.uid); 
            } else {
                window.location.href = '../pages/login-professor.html'; 
            }
        });

        async function carregarProfessor(userId) {
    try {
        const professorDoc = await db.collection('professores')
            .where('uid', '==', userId) // Consulta pelo UID
            .get();

            if (!professorDoc.empty) {
    const professorData = professorDoc.docs[0].data();
    nomeProfessorSpan.textContent = professorData.nome;

    // Obtém o ID da instituição do professor
    const instituicaoUserId = professorData.instituicao; // Corrigido: usar instituicao (userId)

    // Chama a função para carregar as turmas, passando o ID da instituição
    carregarTurmasDoProfessor(professorData.email, instituicaoUserId); 
  } else {
            // Lidar com o caso em que o professor não é encontrado
            console.error('Professor não encontrado no banco de dados!');
            nomeProfessorSpan.textContent = 'Professor não encontrado';
        }
    } catch (error) {
        console.error('Erro ao carregar dados do professor:', error);
        nomeProfessorSpan.textContent = 'Erro ao carregar dados';
    }
}

async function carregarTurmasDoProfessor(professorEmail, instituicaoUserId) {
  try {
    // 1. Buscar a instituição pelo userId
    const instituicaoSnapshot = await db.collection('instituicoes')
      .where('nome', '==', instituicaoUserId)
      .get();

    if (!instituicaoSnapshot.empty) {
      const instituicaoDoc = instituicaoSnapshot.docs[0];
      const turmasRef = instituicaoDoc.ref.collection('turmas');

      // 2. Obter todas as turmas da instituição
      const turmasSnapshot = await turmasRef.get();

      // 3. Iterar pelas turmas e verificar a subcoleção 'professores'
      const turmasDoProfessor = []; 
      for (const turmaDoc of turmasSnapshot.docs) {
        const professoresTurmaSnapshot = await turmaDoc.ref.collection('professores')
          .where('email', '==', professorEmail)
          .get();

        // 4. Se o professor estiver na subcoleção, adicionar a turma à lista
        if (!professoresTurmaSnapshot.empty) {
          turmasDoProfessor.push(turmaDoc.data());
        }
      }

      // 5. Exibir as turmas encontradas
      if (turmasDoProfessor.length > 0) {
        turmasDoProfessor.forEach(turmaData => {
          const turmaElement = `
            <div class="products-row" data-turma-id="${turmaData.id}">
              <div class="product-cell category">
                <span class="cell-label">Turma:</span>
                <a href="turma.html?turma=${encodeURIComponent(turmaData.turma)}">${turmaData.turma}</a>  
              </div>
            </div>
          `;
          conteudoPrincipal.innerHTML += turmaElement;
        });
      } else {
        conteudoPrincipal.innerHTML += '<p>Você não está atribuído a nenhuma turma.</p>';
      }
    } else {
      console.error('Instituição não encontrada com userId:', instituicaoUserId);
      // Tratar o caso em que a instituição não é encontrada
    }
  } catch (error) {
    console.error('Erro ao carregar turmas do professor:', error);
    conteudoPrincipal.innerHTML += '<p>Erro ao carregar turmas.</p>';
  }
}

    </script>
</body>
</html>